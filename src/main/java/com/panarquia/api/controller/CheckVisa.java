package com.panarquia.api.controller;

import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.util.Base64;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.apache.commons.io.IOUtils;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

@Component
@RestController
@RequestMapping("/visa")
public class CheckVisa {

	private String urlS = "curl 'https://onlineservices.immigration.govt.nz/PaymentGateway/OnLinePayment.aspx?ProductId=2&SourceUrl=%2f%2fonlineservices.immigration.govt.nz%2fWorkingHoliday%2fApplication%2fSubmitConfirmation.aspx%3fApplicationId%3d1935595&Token=LctQ9Y5g+5WanrJmA6S2WfJosX2EAYHGE7eJRKJRsI%2fZehNcgvOibCpK0JSZPM7cwEiEYEkiNzU%3d' -H 'Cookie: RanId=357517119; BIGipServer~Public~vs-onlinechannel2.ext.wd.govt.nz_443.app~vs-onlinechannel2.ext.wd.govt.nz_443_pool=rd1906o00000000000000000000ffff0ae82283o80; __RequestVerificationToken=Uxguula3Z23Np1bJSVGZe20N5oHHNBlr7GNKtmCeXgkNdrB376E33Y_j81vPoD6q5s6-HDVAz-qLuKNBN1rvdxZLT341; ASP.NET_SessionId=pctztmwyng0mcwtctlsxmvak; NZIS_CSSMCookieData=PageHistory=/wEWBQUrJTJmQ1NTTSUyZldpemFyZCUyZlByaW1hcnlFbmdsaXNoUGFydDMuYXNweAUxJTJmQ1NTTSUyZldpemFyZCUyZlN1bW1hcnkuYXNweCUzZkVPSUlEJTNkMTQ0NDYxNgUnJTJmQ1NTTSUyZldpemFyZCUyZlByaW1hcnlDaGlsZHJlbi5hc3B4BSolMmZDU1NNJTJmV2l6YXJkJTJmUHJpbWFyeU90aGVyRmFtaWx5LmFzcHgFKSUyZkNTU00lMmZXaXphcmQlMmZQcmltYXJ5QXNzaXN0ZWRCeS5hc3B4&EOIID=1444616&DisplayMandatoryFieldErrorMessages=False; TSPD_101=08819c2a25ab28000f21066f042cd1660a522858fc0e8e0da6eb9aee3c20be562250f2ed50023fbdd68c5350d8d7232b0857044fef0510005bd90579140a5a8c9483047df012ed90:; _ga=GA1.3.1236919676.1505173178; _gid=GA1.3.1574629585.1505683632; ImmigrationAuth=37E1A16FE3D398664F32C23D9EB26AB38BF11D2EA00D005CCDF59E4E11F4FE1B18A7D8AC472164EEAC70307C1C05B4DD4108340D5B7D3060FB9B20574A9F4FCE4C3DC08CE3E128EEE9EF3A88A0FB127B320FF979489BB570FB25EA49EA20E8B04B373FAE81ABABD666E05A7FA9F9A47D2E4328DDFAA023235B11757D613972D87AAE554B8BAC78B7F725F597376B805F52CAC32C0FA9405399B13FCE09728C83D4812BE6D0B290D58D57A9ECCB84D6D0A63D5F62B866B54AA02616568A9FC575FE0C1C3B52286C14E16297DE18A6EA8795A867E740844D35F32BD3A5744D05A6FBC759C25AB0E357EF656884FE1CBF7CD62E3DC1C26527C712D77FE45E587D22FCBF52519B0B456B60A13D632C0C30C0A1E6CA77030B65ACA93EE6ADBC02B6B702ECDD1C339B2A61CD9182C5DF5C402829D3174D3FCD8CFBA22A3974C5CCD79A991ED9062012193C550904801D6B5BFB5A10510128F9A0EAAC4243EA72CE6F33003CF704A4B0F9CFE992519A969E8D5A971F7CBDB1CE3CC5EA077DE407F6708F86AC682D079C702E536850612F0DCDA6055323EFD6835CFEF69F27C88C5DC00A5D42645E9379D1D5E758A1F72B8DB05E39F50C7D99ED9896FE647649BA00F3B0D31B04F8; NZISWorkingHolidayData=PageHistory=/wEWBQWzAiUyZlBheW1lbnRHYXRld2F5JTJmT25MaW5lUGF5bWVudC5hc3B4JTNmUHJvZHVjdElkJTNkMiUyNlNvdXJjZVVybCUzZCUyNTJmJTI1MmZvbmxpbmVzZXJ2aWNlcy5pbW1pZ3JhdGlvbi5nb3Z0Lm56JTI1MmZXb3JraW5nSG9saWRheSUyNTJmQXBwbGljYXRpb24lMjUyZlN1Ym1pdENvbmZpcm1hdGlvbi5hc3B4JTI1M2ZBcHBsaWNhdGlvbklkJTI1M2QxOTM1NTk1JTI2VG9rZW4lM2RMY3RROVk1ZyUyYjVXYW5ySm1BNlMyV2ZKb3NYMkVBWUhHRTdlSlJLSlJzSSUyNTJmWmVoTmNndk9pYktiaUxMZzc0NFpTT1ZvQXUlMjUyZnJlejkwJTI1M2QFICUyZldvcmtpbmdIb2xpZGF5JTJmZGVmYXVsdC5hc3B4BY0BJTJmV29ya2luZ0hvbGlkYXklMmZBcHBsaWNhdGlvbiUyZlBheS5hc3B4JTNmVG9rZW4lM2RMY3RROVk1ZyUyNTJiNVdhbnJKbUE2UzJXZkpvc1gyRUFZSEdFN2VKUktKUnNJJTI1MmZaZWhOY2d2T2liQ3BLMEpTWlBNN2N3RWlFWUVraU56VSUyNTNkBZ0CJTJmUGF5bWVudEdhdGV3YXklMmZPbkxpbmVQYXltZW50LmFzcHglM2ZQcm9kdWN0SWQlM2QyJTI2U291cmNlVXJsJTNkJTJmJTJmb25saW5lc2VydmljZXMuaW1taWdyYXRpb24uZ292dC5ueiUyZldvcmtpbmdIb2xpZGF5JTJmQXBwbGljYXRpb24lMmZTdWJtaXRDb25maXJtYXRpb24uYXNweCUzZkFwcGxpY2F0aW9uSWQlM2QxOTM1NTk1JTI2VG9rZW4lM2RMY3RROVk1ZyUyYjVXYW5ySm1BNlMyV2ZKb3NYMkVBWUhHRTdlSlJLSlJzSSUyZlplaE5jZ3ZPaWJDcEswSlNaUE03Y3dFaUVZRWtpTnpVJTNkBa8CJTJmUGF5bWVudEdhdGV3YXklMmZPbkxpbmVQYXltZW50LmFzcHglM2ZQcm9kdWN0SWQlM2QyJTI2U291cmNlVXJsJTNkJTI1MmYlMjUyZm9ubGluZXNlcnZpY2VzLmltbWlncmF0aW9uLmdvdnQubnolMjUyZldvcmtpbmdIb2xpZGF5JTI1MmZBcHBsaWNhdGlvbiUyNTJmU3VibWl0Q29uZmlybWF0aW9uLmFzcHglMjUzZkFwcGxpY2F0aW9uSWQlMjUzZDE5MzU1OTUlMjZUb2tlbiUzZExjdFE5WTVnJTJiNVdhbnJKbUE2UzJXZkpvc1gyRUFZSEdFN2VKUktKUnNJJTI1MmZaZWhOY2d2T2liQ3BLMEpTWlBNN2N3RWlFWUVraU56VSUyNTNk&DisplayMandatoryFieldErrorMessages=False&PaymentGateWay_SourceUrl=//onlineservices.immigration.govt.nz/WorkingHoliday/Application/SubmitConfirmation.aspx?ApplicationId=1935595&PaymentGateWay_Token=LctQ9Y5g 5WanrJmA6S2WfJosX2EAYHGE7eJRKJRsI/ZehNcgvOibCpK0JSZPM7cwEiEYEkiNzU=&PaymentGateWay_ApplicationID=1935595&PaymentGateWay_ProductID=2; TS013d8ed5=0105b6b7b687efec2828e15b33f4d0cf858e5d4a6d7e4d5a52ee645063f6b2f4add2aca5f9330adca5b4c4886be129f68f790129b11730c134bce75e08e5160ef52c6b0ae51b13a642e18d3b181cecab07ac294b270aae45dc03738a444b55cb718d02cfcfb9d97045445b762f4b1e52ac1ba30d7b2a42b9523acf35ed918ca605d2a7fbe10e5cb1e7e41ec454231fff3882a45ef9' -H 'Origin: https://onlineservices.immigration.govt.nz' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.8' -H 'Upgrade-Insecure-Requests: 1' -H 'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8' -H 'Cache-Control: max-age=0' -H 'Referer: https://onlineservices.immigration.govt.nz/PaymentGateway/OnLinePayment.aspx?ProductId=2&SourceUrl=%2f%2fonlineservices.immigration.govt.nz%2fWorkingHoliday%2fApplication%2fSubmitConfirmation.aspx%3fApplicationId%3d1935595&Token=LctQ9Y5g+5WanrJmA6S2WfJosX2EAYHGE7eJRKJRsI%2fZehNcgvOibCpK0JSZPM7cwEiEYEkiNzU%3d' -H 'Connection: keep-alive' --data '__EVENTTARGET=&__EVENTARGUMENT=&__VIEWSTATE=%2BPQHrOZDhsIYF1NarojZ6mcdw9KZxMGJ1YSyArYUxRTb6w1fP7asEAkCVfUEZVzapWvFu%2FeIZLIan2veBY25JZ%2FEkOzAon10L%2FRggxnUVX0shhZJeFFu%2BCV6D60LvW6xS%2BgGKUTcRIsYQgBzezzEmxoROhM%3D&__VIEWSTATEGENERATOR=64EC2CD5&__EVENTVALIDATION=apTK9u42Bxe%2FDtV6wl4jKyJrOm7v3WjFrZWHa2E8mzgihiu6Js38zrTQ5yWZN0AOrB0QFdbC5FmZHZ%2FGbNTXfrEQSWdpaA8G2Sq4dpXRn2HBc5%2FnsKmdxTWGhH%2BD983Zx0oxiN9dadwTyz7WY3nqB6F6CvU%3D&_ctl0%3AContentPlaceHolder1%3ApayerNameTextBox=123&_ctl0%3AContentPlaceHolder1%3AokButton=OK' --compressed";

	// @Scheduled(initialDelay = 1000, fixedDelay = 5000)
	@RequestMapping(method = RequestMethod.GET)
	public String check() {
		boolean matches = false;

		try {
			Runtime runtime = Runtime.getRuntime();

			Process process = runtime.exec(urlS);

			String page = IOUtils.toString(process.getInputStream());

			String patternString = "Scheme unavailable because: Unfortunately";

			Pattern pattern = Pattern.compile(patternString);

			Matcher matcher = pattern.matcher(page);

			matches = matcher.find();
		} catch (Exception e) {
			return e.getMessage();
		}

		return String.valueOf(matches);
	}

}
